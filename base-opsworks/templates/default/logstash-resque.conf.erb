input {

  file {
    'exclude' => ["production*log", "unicorn*log", "salesforce*", "mail_delivery.log", "newrelic*", "cron*", "bluepill*", "resque*log"]
    'path' => ["/srv/www/corndog/shared/log/*.log"]
    'tags' => ["catchall"]
    'type' => "catchall"
  }

  file {
    'path' => ["/srv/www/corndog/shared/log/production*.log"]
    'tags' => ["rails"]
    'type' => "rails"
  }

  file {
    'path' => ["/srv/www/corndog/shared/log/salesforce_offer_thread_monitor.log"]
    'tags' => ["salesforce", "offer_thread"]
    'type' => "salesforce_offer_thread"
  }

  file {
    'path' => ["/srv/www/corndog/shared/log/mail_delivery.log"]
    'tags' => ["mail_delivery"]
    'type' => "mail_delivery"
  }

  file {
    'path' => ["/srv/www/corndog/shared/log/resque*log"]
    'tags' => ["resque"]
    'type' => "resque"
  }

  file {
    'path' => ["/var/lib/aws/opsworks/chef/*.log"]
    'tags' => ["deploy", "chef"]
    'type' => "deploy"
  }
}

filter {
  if [message] =~ /^$/ {
    grok {
      match => ["message", "^$"]
      drop_if_match => true
    }
  }
  if "rails" in [tags] {
    multiline {
      pattern => "^\s"
      what => "previous"
    }
    date {
      add_tag => 'ts'
        match => [ "year-month-day hour:minute:second timezone",
                   "YYYY-MM-dd HH:mm:ss Z" ]
    }
  }
  if [type] == "salesforce_offer_thread" {
    grok {
      'match' => ["message", "\[%{TIMESTAMP_ISO8601:timestamp}\] \[%{LOGLEVEL:log_level}\] \[%{DATA:message}\] \[%{NUMBER:occurrences}\]"]
    }
  }

  if [type] == "deploy" {
    grok {
      'match' => ["message", "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:level}: %{GREEDYDATA:msg}"]
    }
    date {
      'add_tag' => "ts"
      'match' => ["timestamp", "ISO8601"]
    }
  }

  mutate {
    'add_tag' => [ "<%= @stack_name %>", "v002" ]
  }
}

output {
  redis {
    'data_type' => "list"
    'host' => "logs.dealermatch.biz"
    'key' => "logstash"
    'port' => "16379"
  }
}

