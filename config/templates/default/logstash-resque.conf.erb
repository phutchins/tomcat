input {

  file {
    'exclude' => ["production*log", "unicorn*log", "salesforce*", "resque*.log", "mail_delivery.log", "newrelic*", "cron*", "bluepill*"]
    'path' => ["/srv/www/corndog/shared/log/*.log"]
    'tags' => ["catchall"]
    'type' => "catchall"
  }

  file {
    'path' => ["/srv/www/corndog/shared/log/production.log"]
    'tags' => ["rails"]
    'type' => "rails"
  }

  file {
    'path' => ["/srv/www/corndog/shared/log/salesforce_offer_thread_monitor.log"]
    'tags' => ["salesforce", "offer_thread"]
    'type' => "salesforce_offer_thread"
  }

  file {
    'path' => ["/srv/www/corndog/shared/log/resque*.log"]
    'tags' => ["resque"]
    'type' => "resque"
  }

  file {
    'path' => ["/srv/www/corndog/shared/log/mail_delivery.log"]
    'tags' => ["mail_delivery"]
    'type' => "mail_delivery"
  }

  file {
    'path' => ["/var/lib/aws/opsworks/chef/*.log"]
    'tags' => ["deploy", "chef"]
    'type' => "deploy"
  }
}

filter {

  if "rails" in [tags] {
    multiline {
      'pattern' => "^\s|Processing|Completed|Redirected"
         'what' => "previous"
    }
  }

  if [type] == "salesforce_offer_thread" {
    grok {
      'match' => ["message", "\[%{TIMESTAMP_ISO8601:timestamp}\] \[%{LOGLEVEL:log_level}\] \[%{DATA:message}\] \[%{NUMBER:occurrences}\]"]
    }
  }

  if [type] == "deploy" {
    grok {
      'match' => ["message", "\[%{TIMESTAMP_ISO8601:timestamp}\] %{DATA:level}: %{GREEDYDATA:msg}"]
    }
    date {
      'add_tag' => "ts"
        'match' => ["timestamp", "ISO8601"]
    }
  }

  mutate {
    'add_tag' => ["<%= @stack_name %>", "<%= @host_role %>"]
  }
}

output {
  redis {
    'data_type' => "list"
    'host' => "logstash-redis.dealermatch.biz"
    'key' => "logstash"
    'port' => "16379"
  }
}

