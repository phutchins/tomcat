slugname = '<%= @deploy_to %>'
pid_dir  = "#{slugname}/shared/pids"
log_dir  = "#{slugname}/shared/log"
conf_dir = "#{slugname}/current/config"

Bluepill.application("resque", :log_file => "#{log_dir}/bluepill.log") do |app|
  app.working_dir = "#{slugname}/current"
  app.uid = 'root'
  app.gid = 'root'

  priority_processes = [
    [:high, 2, { 'QUEUES' => 'high' }],
    [:medium, 3, { 'QUEUES' => 'high,medium,medium_low' }],
    [:low, 5, { 'QUEUES' => 'high,medium,medium_low,low,*' }]
  ]

  priority_processes.each do |priority_process|
    priority = priority_process[0]
    process_count = priority_process[1]
    environment = priority_process[2]
    process_count.times do |process_num|
      app.process("resque_#{priority}_#{process_num}") do |process|
        process.stdout = process.stderr = "#{log_dir}/resque_#{priority}.log"
        process.group = "resque-workers"
        process.pid_file = "#{pid_dir}/resque_#{priority}_#{process_num}.pid"
        process.environment = environment.merge({ 'RAILS_ENV' => '<%= @rails_env %>' })
        process.start_command = "bundle exec rake resque:work"
        process.stop_command = "kill -QUIT {{PID}}"
        process.daemonize = true
      end
    end
  end

  app.process("resque_scheduler") do |process|
    process.stdout = process.stderr = "#{log_dir}/resque_scheduler.log"
    process.group = "resque-scheduler"
    process.pid_file = "#{pid_dir}/resque_scheduler.pid"
    process.environment = { 'RAILS_ENV' => '<%= @rails_env %>' }
    process.start_command = "bundle exec rake resque:scheduler"
    process.stop_command = "kill -QUIT {{PID}}"
    process.daemonize = true
  end # resque_scheduler

  app.process("resque_web") do |process|
    process.stdout = process.stderr = "#{log_dir}/resque_web.log"
    process.group = "resque-web"
    process.pid_file = "#{pid_dir}/resque_web.pid"
    process.start_command = "bundle exec resque-web -L -p 8888 #{conf_dir}/resque_conf.rb -P #{pid_dir}/resque_web.pid"
    process.stop_command  = "kill -QUIT {{PID}}"
    process.daemonize = true
    process.start_grace_time =    10.seconds
  end # resque_web

end # resque

