Bluepill.application("resque-workers", :log_file => "/var/log/bluepill.log") do |app|
  app.working_dir = "/data/<%= @app_name %>/current"
  app.uid = 'root'
  app.gid = 'root'
  <% @workers_config.each do |queue, workers_count| %>
  <% count = 0 %>
  <% workers_count.times do %>
  app.process("resque_<%= queue %>_<%= count %>") do |process|
    process.stdout = process.stderr = "resque_<%= queue %>_<%= count %>.log"
    process.group = "resque-workers"
    process.pid_file = "/data/run/resque_<%= queue %>_<%= count %>.pid"
    process.environment = { 'RAILS_ENV' => '<%= @rails_env %>', 'QUEUE' => '<%= queue %>' }
    process.start_command = "bundle exec rake resque:work"
    process.stop_command = "kill -QUIT {{PID}}"
    process.daemonize = true
    #process.checks :mem_usage, :every => 30.seconds, :above => 600.megabytes, :times => [3,5]
    #process.start_grace_time =     60.seconds
    #process.stop_grace_time =      15.seconds
    #process.restart_grace_time =  120.seconds
    #process.monitor_children do |c|
    #  c.stop_command = "kill -USR1 {{PID}}"
     # #c.checks :mem_usage, :every => 30.seconds, :below => 100.megabytes, :fires => :stop
    #end
    # production alerts go here
    <%# if ['production'].include?(@rails_env) %>
    #alert cdx-alert@manheim.com only on { timeout, nonexist }
    <%# end %>
  end
    <% count += 1 %>
  <% end %>
<% end %>
end

